---
import '../styles/global.css';
import '../styles/fonts.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import LocalSchema from '../components/LocalSchema.astro';
import WhatsAppButton from '../components/WhatsAppButton.astro';
import MobileStickyBar from '../components/MobileStickyBar.astro';
import ScrollToTop from '../components/ScrollToTop.astro';
import CookieBanner from '../components/CookieBanner.astro';
import { siteConfig } from '../config/site';

interface Props {
	title: string;
    description?: string;
    schema?: object;
    keywords?: string;
    image?: string;
    preloadImage?: string;
}

const {
    title,
    description = siteConfig.metadata.description,
    schema,
    keywords = siteConfig.metadata.keywords,
    image = "/images/logo-og.png",
    preloadImage
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
// If image is an external URL, use it directly. If relative, resolve it.
const socialImageURL = image.startsWith('http') ? image : new URL(image, Astro.site);
---
<!doctype html>
<html lang={siteConfig.metadata.locale.split('_')[0]} class={siteConfig.features.enableSmoothScroll ? "scroll-smooth" : ""}>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/png" href="/favicon.png" />
        <link rel="apple-touch-icon" href="/logo.png" />

        <title>{title} | {siteConfig.metadata.siteName}</title>
        <meta name="description" content={description} />
        <meta name="keywords" content={keywords} />
        <link rel="canonical" href={canonicalURL} />

        <!-- GEO & Local -->
        <meta name="geo.region" content={siteConfig.metadata.geo.region} />
        <meta name="geo.placename" content={siteConfig.metadata.geo.placename} />
        <meta name="geo.position" content={siteConfig.metadata.geo.position} />
        <meta name="ICBM" content={siteConfig.metadata.geo.icbm} />
        <link rel="manifest" href="/manifest.json" />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content={canonicalURL} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={socialImageURL} />
        <meta property="og:locale" content={siteConfig.metadata.locale} />
        <meta property="og:site_name" content={siteConfig.metadata.siteName} />

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={canonicalURL} />
        <meta property="twitter:title" content={title} />
        <meta property="twitter:description" content={description} />
        <meta property="twitter:image" content={socialImageURL} />

        {/* LCP Preload */}
        {preloadImage && <link rel="preload" as="image" href={preloadImage} fetchpriority="high" />}

        {schema && <script type="application/ld+json" set:html={JSON.stringify(schema)} />}
        <LocalSchema />
        <script is:inline>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js?v=3').catch(err => console.error('SW registration failed:', err));
                });
            }
        </script>
	</head>
	<body class="bg-background text-zinc-100 antialiased min-h-screen flex flex-col selection:bg-primary-600 selection:text-white overflow-x-hidden">
        <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 z-[100] px-4 py-2 bg-white text-black font-bold rounded shadow-lg ring-2 ring-primary-500">
            Zum Inhalt springen
        </a>
        <Header />
        <div id="main-content" class="flex-grow">
		    <slot />
        </div>
        <Footer />
        <div class="hidden md:block">
            <WhatsAppButton />
        </div>
        {/* Mobile Sticky Bar should ideally check config too, but for now we leave it */}
        <MobileStickyBar />
        <ScrollToTop />
        <CookieBanner />
	</body>
</html>
