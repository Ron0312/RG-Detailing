---
import fs from 'node:fs/promises';
import path from 'node:path';
import type { AnalyticsEvent } from '../../types/analytics';

// Auth Check (Simple)
const url = new URL(Astro.request.url);
const key = url.searchParams.get('key');
const isDev = import.meta.env.DEV;
const secret = import.meta.env.STATS_SECRET || 'RG!123';

if (key !== secret) {
    return new Response(`Unauthorized. Access Denied.`, { status: 401 });
}

// Read Logs
const logDir = path.resolve('logs');
const logFile = path.join(logDir, 'events.jsonl');
const errorLogFile = path.join(logDir, '404.log');

// Date Filter Logic
const filterRange = url.searchParams.get('range') || 'all';
const now = Date.now();
const oneDay = 24 * 60 * 60 * 1000;
const filterCutoff = filterRange === '7d' ? now - (7 * oneDay) : (filterRange === '30d' ? now - (30 * oneDay) : 0);

let events: AnalyticsEvent[] = [];
let notFoundErrors: { timestamp: string; url: string; referrer: string; ua: string; }[] = [];

// Simple In-Memory Cache
const CACHE_TTL = 5 * 1000; // 5s (Realtime)
// @ts-ignore
if (!globalThis.analyticsCache) globalThis.analyticsCache = { data: [], lastFetch: 0 };
// @ts-ignore
const cache = globalThis.analyticsCache;

try {
    const nowTs = Date.now();
    let rawEvents: AnalyticsEvent[] = [];

    // Check for Bypass
    const noCache = url.searchParams.has('nocache');

    // Use Cache if fresh
    if (!noCache && cache.data.length > 0 && (nowTs - cache.lastFetch) < CACHE_TTL) {
        rawEvents = cache.data;
    } else {
        const content = await fs.readFile(logFile, 'utf-8');
        rawEvents = content.trim().split('\n').map(line => {
            try { return JSON.parse(line); } catch(e) { return null; }
        }).filter((e): e is AnalyticsEvent => {
            if (!e) return false;
            // Filter out Admin/Dev logs (retroactive cleaning)
            if (e.url?.includes('/admin') || e.url?.includes('/keystatic')) return false;
            return true;
        });

        // Update Cache
        cache.data = rawEvents;
        cache.lastFetch = nowTs;
    }

    // Apply Filters (Always fresh from rawEvents)
    events = rawEvents.filter(e => {
        if (filterCutoff > 0) {
            const eventTime = new Date(e.timestamp).getTime();
            if (eventTime < filterCutoff) return false;
        }
        return true;
    });

} catch (e) {
    // No logs yet
}

try {
    const errorContent = await fs.readFile(errorLogFile, 'utf-8');
    // Parse: [ISO] 404: /url (Referrer: ...) - UA: ...
    notFoundErrors = errorContent.trim().split('\n').map(line => {
        const match = line.match(/^\[(.*?)\] 404: (.*?) \(Referrer: (.*?)\) - UA: (.*)$/);
        if (match) {
            return {
                timestamp: match[1],
                url: match[2],
                referrer: match[3],
                ua: match[4]
            };
        }
        return null;
    }).filter((e): e is NonNullable<typeof e> => e !== null).reverse().slice(0, 50); // Last 50 errors
} catch (e) {
    // No error logs yet
}

// Aggregation
const totalEvents = events.length;
const eventsByName: Record<string, number> = {};
const services: Record<string, number> = {};
const galleryFilters: Record<string, number> = {};
const calculator: { start: number; steps: Record<string, number>; submit: number } = {
    start: 0,
    steps: {},
    submit: 0
};
const devices: Record<string, number> = {};
const browsers: Record<string, number> = {};
const os: Record<string, number> = {};
const referrers: Record<string, number> = {};
const scrollDepth: Record<string, number> = {};
const pages: Record<string, { views: number; time: number; timeCount: number; bounces: number }> = {};
const readingBehavior: Record<string, number> = { read: 0, skim: 0 };
const intents: Record<string, number> = {};
// New Aggregations
const exitPages: Record<string, number> = {};
const elementViews: Record<string, number> = {};
const contactClicks: Record<string, Record<string, number>> = {}; // channel -> location -> count
const faqInteractions: Record<string, number> = {};
const dayHeatmap: Record<string, number> = {}; // Day (0-6)
const hourHeatmap: Record<string, number> = {}; // Hour (0-23)
const lcpByPage: Record<string, { total: number; count: number }> = {};
const seoIssues: Record<string, number> = {};
const feedbackStats: Record<string, number> = { positive: 0, negative: 0 };

let totalTimeOnPage = 0;
let timeOnPageCount = 0;

// Temporal Data for Charts
const history: Record<string, { views: number; visitors: Set<string> }> = {};
// Live Data
const liveUsers = new Set<string>();

// Session Analysis for Exits
const sessions: Record<string, { lastUrl: string; lastTime: number; startPage: string }> = {};

events.forEach(e => {
    // Date Key (YYYY-MM-DD)
    const dObj = new Date(e.timestamp);
    const dateKey = e.timestamp.split('T')[0];
    const day = dObj.getDay(); // 0-6
    const hour = dObj.getHours(); // 0-23

    if (!history[dateKey]) history[dateKey] = { views: 0, visitors: new Set() };

    // Live Ticker (Active in last 5 mins)
    const eventTime = dObj.getTime();
    if (now - eventTime < 5 * 60 * 1000) {
        liveUsers.add(e.visitorId || e.dailyHash || e.sessionId || 'anon');
    }

    // Heatmap Data (Views only)
    if (e.event === 'page_view') {
        dayHeatmap[day] = (dayHeatmap[day] || 0) + 1;
        hourHeatmap[hour] = (hourHeatmap[hour] || 0) + 1;
    }

    eventsByName[e.event] = (eventsByName[e.event] || 0) + 1;

    // Track Views & Visitors
    if (e.event === 'page_view') {
        history[dateKey].views++;
        // Use visitorId if available, else dailyHash, else sessionId
        const uniqueId = e.visitorId || e.dailyHash || e.sessionId;
        if (uniqueId) history[dateKey].visitors.add(uniqueId);

        if (e.url) {
            if (!pages[e.url]) pages[e.url] = { views: 0, time: 0, timeCount: 0, bounces: 0 };
            pages[e.url].views++;

            // Track Session Flow (Landing & Exit)
            const sid = e.sessionId || 'unknown';
            if (!sessions[sid]) sessions[sid] = { lastUrl: e.url, lastTime: eventTime, startPage: e.url };
            sessions[sid].lastUrl = e.url;
            sessions[sid].lastTime = eventTime;
        }
    }

    // Explicit Exit Tracking
    if (e.event === 'page_exit' && e.url) {
        exitPages[e.url] = (exitPages[e.url] || 0) + 1;
    }

    // Context Stats
    if (e.data?.device) devices[e.data.device] = (devices[e.data.device] || 0) + 1;
    if (e.browser) browsers[e.browser] = (browsers[e.browser] || 0) + 1;
    if (e.os) os[e.os] = (os[e.os] || 0) + 1;

    if (e.data?.referrer && e.data.referrer !== 'direct' && !e.data.referrer.includes(url.host)) {
        const ref = e.data.referrer.replace('https://', '').replace('http://', '').split('/')[0];
        referrers[ref] = (referrers[ref] || 0) + 1;
    }

    if (e.event === 'service_click') {
        const s = e.data?.service || 'Unknown';
        services[s] = (services[s] || 0) + 1;
    }
    if (e.event === 'gallery_filter') {
        const c = e.data?.category || 'Unknown';
        galleryFilters[c] = (galleryFilters[c] || 0) + 1;
    }
    if (e.event === 'calculator_start') {
        calculator.start++;
    }
    if (e.event === 'calculator_step') {
        const s = String(e.data?.step);
        if (s) {
             calculator.steps[s] = (calculator.steps[s] || 0) + 1;
        }
    }
    if (e.event === 'calculator_submit') {
        calculator.submit++;
    }
    if (e.event === 'time_on_page' && e.data?.duration) {
        const d = Number(e.data.duration);
        totalTimeOnPage += d;
        timeOnPageCount++;
        if (e.url) {
            if (!pages[e.url]) pages[e.url] = { views: 0, time: 0, timeCount: 0, bounces: 0 };
            pages[e.url].time += d;
            pages[e.url].timeCount++;
        }
    }
    if (e.event === 'scroll_depth' && e.data?.depth) {
        const d = String(e.data.depth);
        scrollDepth[d] = (scrollDepth[d] || 0) + 1;
    }
    if (e.event === 'reading_behavior' && e.data?.type) {
        const t = e.data.type as 'read' | 'skim';
        if (readingBehavior[t] !== undefined) readingBehavior[t]++;
    }
    if (e.event === 'intent_copy' && e.data?.text) {
        const t = String(e.data.text);
        intents[t] = (intents[t] || 0) + 1;
    }
    if (e.event === 'feedback_submitted' && e.data?.value) {
        const v = e.data.value as 'positive' | 'negative';
        if (feedbackStats[v] !== undefined) feedbackStats[v]++;
    }
    if (e.event === 'element_view' && e.data?.elementId) {
        const el = e.data.elementId;
        elementViews[el] = (elementViews[el] || 0) + 1;
    }
    if (e.event === 'contact_click' && e.data?.channel) {
        const ch = e.data.channel;
        const loc = e.data.location || 'unknown';
        if (!contactClicks[ch]) contactClicks[ch] = {};
        contactClicks[ch][loc] = (contactClicks[ch][loc] || 0) + 1;
    }
    if (e.event === 'faq_toggle' && e.data?.question) {
        const q = e.data.question;
        faqInteractions[q] = (faqInteractions[q] || 0) + 1;
    }
    if (e.event === 'performance_metric' && e.data?.metric === 'LCP' && e.url) {
        if (!lcpByPage[e.url]) lcpByPage[e.url] = { total: 0, count: 0 };
        lcpByPage[e.url].total += Number(e.data.value);
        lcpByPage[e.url].count++;
    }
    if (e.event === 'seo_issue' && e.data?.type) {
        const issue = `${e.data.type} on ${e.data.url || 'unknown'}`;
        seoIssues[issue] = (seoIssues[issue] || 0) + 1;
    }
});

// Calculate History Array (Last 30 Days)
const sortedDates = Object.keys(history).sort();
// Fill missing dates? For simple MVP, just show active days.
const chartData = sortedDates.map(date => ({
    date,
    views: history[date].views,
    visitors: history[date].visitors.size
}));

const totalUniqueVisitors = new Set(events.map(e => e.visitorId || e.dailyHash || e.sessionId).filter(Boolean)).size;
const liveUserCount = liveUsers.size;

// Landing Pages
const landingPages: Record<string, number> = {};
Object.values(sessions).forEach(s => {
    landingPages[s.startPage] = (landingPages[s.startPage] || 0) + 1;
});
const topLanding = Object.entries(landingPages).sort((a, b) => b[1] - a[1]).slice(0, 10);

const topServices = Object.entries(services).sort((a, b) => b[1] - a[1]).slice(0, 10);
const topGallery = Object.entries(galleryFilters).sort((a, b) => b[1] - a[1]);
const allEvents = Object.entries(eventsByName).sort((a, b) => b[1] - a[1]);
const stepKeys = Object.keys(calculator.steps).sort((a, b) => Number(a) - Number(b));
const topDevices = Object.entries(devices).sort((a, b) => b[1] - a[1]);
const topBrowsers = Object.entries(browsers).sort((a, b) => b[1] - a[1]);
const topOS = Object.entries(os).sort((a, b) => b[1] - a[1]);
const topReferrers = Object.entries(referrers).sort((a, b) => b[1] - a[1]);
const scrollKeys = Object.keys(scrollDepth).sort((a, b) => Number(a) - Number(b));
const topIntents = Object.entries(intents).sort((a, b) => b[1] - a[1]).slice(0, 5);
const topExitPages = Object.entries(exitPages).sort((a, b) => b[1] - a[1]).slice(0, 10);
const topElementViews = Object.entries(elementViews).sort((a, b) => b[1] - a[1]);
const topFAQs = Object.entries(faqInteractions).sort((a, b) => b[1] - a[1]).slice(0, 5);
const topSEOIssues = Object.entries(seoIssues).sort((a, b) => b[1] - a[1]).slice(0, 5);

// Performance Table
const performanceTable = Object.entries(lcpByPage).map(([url, stats]) => ({
    url,
    avgLCP: Math.round(stats.total / stats.count)
})).sort((a, b) => b.avgLCP - a.avgLCP).slice(0, 5);

// Calculate contact totals
const contactTotals = Object.entries(contactClicks).map(([channel, locs]) => {
    const total = Object.values(locs).reduce((sum, v) => sum + v, 0);
    return { channel, total, locations: locs };
}).sort((a, b) => b.total - a.total);


// Process Top Pages
const topPages = Object.entries(pages)
    .map(([url, stats]) => ({
        url,
        views: stats.views,
        avgTime: stats.views > 0 ? Math.round(stats.time / stats.views) : 0 // Corrected average logic
    }))
    .sort((a, b) => b.views - a.views)
    .slice(0, 15);

// Calculate Interest Metrics
const homepageViews = pages['/']?.views || 1;
const serviceInterest = topServices.map(([name, count]) => ({
    name,
    count,
    rate: Math.round((count / homepageViews) * 100)
}));

// Goals (Hardcoded for now)
const DAILY_LEAD_TARGET = 3;
const totalLeads = calculator.submit + Object.values(contactClicks).reduce((sum, ch) => sum + Object.values(ch).reduce((a, b) => a + b, 0), 0);
// Normalize to daily if range is 'all' (approx) or '30d'
const daysInRange = filterRange === '7d' ? 7 : (filterRange === '30d' ? 30 : (events.length > 0 ? (Date.now() - new Date(events[events.length-1].timestamp).getTime()) / (1000 * 60 * 60 * 24) : 1));
const dailyLeadsAvg = totalLeads / Math.max(daysInRange, 1);
const goalProgress = Math.min((dailyLeadsAvg / DAILY_LEAD_TARGET) * 100, 100);

const totalViews = events.filter(e => e.event === 'page_view').length;
const avgTimeOnPage = totalViews > 0 ? Math.round(totalTimeOnPage / totalViews) : 0;
const formatTime = (s: number) => {
    if (!s) return '-';
    const min = Math.floor(s / 60);
    const sec = s % 60;
    return `${min}m ${sec}s`;
}

let logSize = 0;
try {
    const stat = await fs.stat(logFile);
    logSize = stat.size;
} catch (e) {}

// SVG Chart Generator
const maxVal = Math.max(...chartData.map(d => d.views), 10);
const chartHeight = 150;
const chartWidth = 1000;
const pointsViews = chartData.map((d, i) => {
    const x = (i / (chartData.length - 1 || 1)) * chartWidth;
    const y = chartHeight - (d.views / maxVal) * chartHeight;
    return `${x},${y}`;
}).join(' ');
const pointsVisitors = chartData.map((d, i) => {
    const x = (i / (chartData.length - 1 || 1)) * chartWidth;
    const y = chartHeight - (d.visitors / maxVal) * chartHeight;
    return `${x},${y}`;
}).join(' ');

// Actionable Insights Logic
interface Insight {
    type: 'critical' | 'warning' | 'success' | 'info';
    message: string;
}
const insights: Insight[] = [];

// 1. 404 Analysis
if (notFoundErrors.length > 0) {
    const unique404s = [...new Set(notFoundErrors.map(e => e.url))];
    insights.push({
        type: 'critical',
        message: `Kritisch: ${unique404s.length} fehlerhafte Links gefunden (z.B. ${unique404s[0]}). Bitte Redirects pr√ºfen.`
    });
}

// 2. Engagement Analysis
if (avgTimeOnPage > 120) {
    insights.push({
        type: 'success',
        message: `Stark: Nutzer bleiben durchschnittlich ${formatTime(avgTimeOnPage)} auf der Seite. Inhalte sind relevant!`
    });
} else if (avgTimeOnPage < 30 && totalViews > 10) {
    insights.push({
        type: 'warning',
        message: `Vorsicht: Kurze Verweildauer (${avgTimeOnPage}s). Pr√ºfe den "Above the Fold" Bereich.`
    });
}

// 3. Calculator Funnel Analysis
if (calculator.start > 5) {
    const conversionRate = (calculator.submit / calculator.start) * 100;
    if (conversionRate < 10) {
        insights.push({
            type: 'warning',
            message: `Potential: Viele Rechner-Starts (${calculator.start}), aber kaum Abschl√ºsse (${Math.round(conversionRate)}%). Formular evtl. zu lang?`
        });
    } else if (conversionRate > 30) {
        insights.push({
            type: 'success',
            message: `Top: Starke Rechner-Conversion (${Math.round(conversionRate)}%). Der Funnel funktioniert!`
        });
    }
}

// 4. Reading Behavior
const totalReaders = readingBehavior.read + readingBehavior.skim;
if (totalReaders > 5) {
    if (readingBehavior.skim > readingBehavior.read * 2) {
        insights.push({
            type: 'info',
            message: `Content: Viele "Skimmer" (${readingBehavior.skim}). Nutze mehr Zwischen√ºberschriften und Fettungen.`
        });
    }
}

// 5. Performance Check
if (performanceTable.length > 0 && performanceTable[0].avgLCP > 2500) {
    insights.push({
        type: 'warning',
        message: `Speed: ${performanceTable[0].url} l√§dt langsam (${performanceTable[0].avgLCP}ms LCP). Bilder optimieren?`
    });
}

// 6. Traffic Source
if (topReferrers.length > 0 && topReferrers[0][1] > totalEvents * 0.3) {
    insights.push({
        type: 'info',
        message: `Traffic-Fokus: ${topReferrers[0][0]} ist deine Hauptquelle (${topReferrers[0][1]} Events). Optimiere Landingpages daf√ºr.`
    });
}

if (insights.length === 0) {
    insights.push({ type: 'info', message: 'Sammle mehr Daten f√ºr detaillierte Insights.' });
}

---

<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>RG Analytics Dashboard</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #111; color: #eee; padding: 2rem; max-width: 1200px; margin: 0 auto; }
        .card { background: #222; padding: 1.5rem; border-radius: 12px; border: 1px solid #333; margin-bottom: 1rem; }
        h1 { color: #ef4444; font-size: 2rem; margin-bottom: 2rem; border-bottom: 1px solid #333; padding-bottom: 1rem; }
        h2 { color: #fff; margin-top: 0; font-size: 1.25rem; margin-bottom: 1rem; border-bottom: 1px solid #333; padding-bottom: 0.5rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        table { width: 100%; text-align: left; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 0.75rem 0.5rem; border-bottom: 1px solid #333; }
        th { color: #888; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        tr:last-child td { border-bottom: none; }
        .bar-container { background: #333; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 6px; width: 100%; }
        .bar { height: 100%; background: #ef4444; border-radius: 3px; transition: width 0.3s ease; }
        .stat-value { font-family: monospace; font-size: 1.1em; color: #fff; }
        .meta { color: #666; font-size: 0.8rem; margin-top: 2rem; text-align: center; }
        .badge { display: inline-block; padding: 0.25em 0.5em; border-radius: 4px; background: #333; color: #aaa; font-size: 0.7rem; margin-left: 0.5rem; }
        .controls { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .btn { background: #333; color: #eee; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; transition: background 0.2s; font-size: 0.9rem; }
        .btn:hover, .btn.active { background: #ef4444; color: #fff; }

        /* Chart */
        .chart-container { width: 100%; height: 200px; position: relative; margin-bottom: 2rem; }
        svg { width: 100%; height: 100%; overflow: visible; }
        .line-views { fill: none; stroke: #ef4444; stroke-width: 2; }
        .line-visitors { fill: none; stroke: #3b82f6; stroke-width: 2; stroke-dasharray: 4; }
        .axis { stroke: #444; stroke-width: 1; }
        .tooltip { position: absolute; background: #333; padding: 0.5rem; border-radius: 4px; border: 1px solid #555; pointer-events: none; opacity: 0; transition: opacity 0.2s; }
        .legend { display: flex; gap: 1rem; font-size: 0.8rem; justify-content: flex-end; margin-bottom: 0.5rem; }
        .dot { width: 8px; height: 8px; display: inline-block; border-radius: 50%; }
        .insight { padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: bold; display: flex; align-items: center; gap: 0.75rem; }
        .insight.critical { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); }
        .insight.warning { background: rgba(234, 179, 8, 0.15); color: #fcd34d; border: 1px solid rgba(234, 179, 8, 0.3); }
        .insight.success { background: rgba(34, 197, 94, 0.15); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.3); }
        .insight.info { background: rgba(59, 130, 246, 0.15); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
        .sticky-header { position: sticky; top: 0; background: rgba(17, 17, 17, 0.95); backdrop-filter: blur(10px); z-index: 50; padding: 1rem 0; margin-bottom: 2rem; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        tr:nth-child(even) { background: #1a1a1a; }
    </style>
</head>
<body>
    <div class="sticky-header">
        <h1 style="border: none; margin: 0; padding: 0;">Analytics Dashboard</h1>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <a href="/api/backup-logs?key=RG!123" class="btn" style="background: #3b82f6;" download>üíæ Backup Logs</a>
            <div class="controls" style="margin: 0;">
                <button class="btn active" onclick="filterData('all')">All Time</button>
                <button class="btn" onclick="filterData('30d')">30 Days</button>
                <button class="btn" onclick="filterData('7d')">7 Days</button>
            </div>
        </div>
    </div>

    <!-- AI Insights -->
    <div class="card" style="margin-bottom: 2rem;">
        <h2>Insights & Actions</h2>
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            {insights.map(i => (
                <div class={`insight ${i.type}`}>
                    {i.type === 'critical' && 'üî¥'}
                    {i.type === 'warning' && 'üü°'}
                    {i.type === 'success' && 'üü¢'}
                    {i.type === 'info' && 'üîµ'}
                    {i.message}
                </div>
            ))}
        </div>
    </div>

    <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <span style="color: #888; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Live (5m)</span>
            <div style="font-size: 2.5rem; font-weight: bold; line-height: 1; color: #22c55e;">{liveUserCount}</div>
        </div>
        <div>
            <span style="color: #888; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Views (Total)</span>
            <div style="font-size: 2.5rem; font-weight: bold; line-height: 1;">{totalEvents}</div>
        </div>
        <div>
            <span style="color: #888; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Visitors</span>
            <div style="font-size: 2.5rem; font-weight: bold; line-height: 1; color: #3b82f6;">{totalUniqueVisitors}</div>
        </div>
        <div>
             <span style="color: #888; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Goal: 3 Leads/Day</span>
             <div style="display: flex; align-items: baseline; gap: 8px;">
                 <div style="font-size: 1.5rem; font-weight: bold; color: #fff;">{dailyLeadsAvg.toFixed(1)}</div>
                 <div style="width: 60px; height: 6px; background: #333; border-radius: 3px;">
                     <div style={`width: ${goalProgress}%; background: ${goalProgress >= 100 ? '#22c55e' : '#eab308'}; height: 100%; border-radius: 3px;`}></div>
                 </div>
             </div>
        </div>
    </div>

    <div class="card" style="display: flex; justify-content: space-between; gap: 1rem;">
        <div style="flex: 1; text-align: center;">
            <div style="font-size: 2rem;">üëç</div>
            <div style="font-weight: bold; font-size: 1.25rem; color: #22c55e;">{feedbackStats.positive}</div>
            <div style="font-size: 0.7rem; color: #888;">Positive</div>
        </div>
        <div style="flex: 1; text-align: center;">
            <div style="font-size: 2rem;">üëé</div>
            <div style="font-weight: bold; font-size: 1.25rem; color: #ef4444;">{feedbackStats.negative}</div>
            <div style="font-size: 0.7rem; color: #888;">Negative</div>
        </div>
    </div>

    <!-- Chart -->
    <div class="card">
        <h2>Trends (Last 30 Days)</h2>
        <div class="legend">
            <span style="color: #ef4444;"><span class="dot" style="background: #ef4444;"></span> Page Views</span>
            <span style="color: #3b82f6;"><span class="dot" style="background: #3b82f6;"></span> Unique Visitors</span>
        </div>
        <div class="chart-container">
            <svg viewBox={`0 0 ${chartWidth} ${chartHeight}`} preserveAspectRatio="none">
                <!-- Axes -->
                <line x1="0" y1={chartHeight} x2={chartWidth} y2={chartHeight} class="axis" />
                <line x1="0" y1="0" x2="0" y2={chartHeight} class="axis" />

                <!-- Data Lines -->
                <polyline points={pointsViews} class="line-views" />
                <polyline points={pointsVisitors} class="line-visitors" />
            </svg>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #888;">
            <span>{chartData[0]?.date}</span>
            <span>{chartData[chartData.length - 1]?.date}</span>
        </div>
    </div>

    <div class="grid">
        <!-- Performance & SEO -->
        <div class="card">
            <h2>System Health</h2>
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Slowest Pages (LCP)</h3>
                <table>
                    <tbody>
                        {performanceTable.map((p) => (
                            <tr>
                                <td>{p.url}</td>
                                <td class="stat-value" style="text-align: right; color: #fca5a5;">{p.avgLCP}ms</td>
                            </tr>
                        ))}
                        {performanceTable.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No perf data</td></tr>}
                    </tbody>
                </table>
            </div>
            <div>
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">SEO Issues</h3>
                <table>
                    <tbody>
                        {topSEOIssues.map(([issue, count]) => (
                            <tr>
                                <td class="text-xs text-yellow-400">{issue}</td>
                                <td class="stat-value" style="text-align: right;">{count}</td>
                            </tr>
                        ))}
                        {topSEOIssues.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">All good!</td></tr>}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Heatmap -->
        <div class="card">
            <h2>Active Times</h2>
            <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Day of Week</h3>
            <div style="display: flex; gap: 4px; height: 100px; align-items: flex-end;">
                {['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'].map((day, i) => {
                    const count = dayHeatmap[i] || 0;
                    const max = Math.max(...Object.values(dayHeatmap), 1);
                    return (
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px;">
                            <div style={`width: 100%; background: #ef4444; border-radius: 4px; height: ${(count/max)*100}%; opacity: ${0.3 + (count/max)*0.7}`}></div>
                            <span style="font-size: 0.7rem; color: #888;">{day}</span>
                        </div>
                    )
                })}
            </div>
        </div>

        <!-- Conversions & Exits -->
        <div class="card" style="grid-column: span 2;">
            <h2>Conversion & Optimization</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <!-- Landing Pages -->
                <div>
                    <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Top Landing Pages</h3>
                    <table>
                        <tbody>
                            {topLanding.map(([url, count]) => (
                                <tr>
                                    <td>{url}</td>
                                    <td class="stat-value" style="text-align: right;">{count}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
                <!-- Exit Pages -->
                <div>
                    <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Top Exit Pages</h3>
                    <table>
                        <tbody>
                            {topExitPages.map(([url, count]) => (
                                <tr>
                                    <td>{url}</td>
                                    <td class="stat-value" style="text-align: right;">{count}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
                <!-- Contact Clicks -->
                <div>
                    <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Contact Channels</h3>
                    <table>
                        <tbody>
                            {contactTotals.map(({channel, total}) => (
                                <tr>
                                    <td style="text-transform: capitalize;">{channel}</td>
                                    <td class="stat-value" style="text-align: right;">{total}</td>
                                </tr>
                            ))}
                            {contactTotals.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No conversions yet</td></tr>}
                        </tbody>
                    </table>
                </div>
                <!-- Element Visibility -->
                <div>
                    <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Element Views</h3>
                    <table>
                        <tbody>
                            {topElementViews.map(([el, count]) => (
                                <tr>
                                    <td>{el}</td>
                                    <td class="stat-value" style="text-align: right;">{count}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Top Pages -->
        <div class="card" style="grid-column: span 2;">
            <h2>Top Pages</h2>
            <table>
                 <thead>
                    <tr>
                        <th>Page</th>
                        <th style="text-align: right;">Views</th>
                        <th style="text-align: right;">Avg Time</th>
                    </tr>
                </thead>
                <tbody>
                    {topPages.map((page) => (
                        <tr>
                            <td>
                                {page.url}
                                <div class="bar-container">
                                    <div class="bar" style={`width: ${(page.views / (topPages[0]?.views || 1)) * 100}%`}></div>
                                </div>
                            </td>
                            <td class="stat-value" style="text-align: right;">{page.views}</td>
                            <td class="stat-value" style="text-align: right; color: #aaa;">{formatTime(page.avgTime)}</td>
                        </tr>
                    ))}
                    {topPages.length === 0 && <tr><td colspan="3" style="color: #666; text-align: center;">No page views yet</td></tr>}
                </tbody>
            </table>
        </div>

        <!-- Visitor Breakdown -->
        <div class="card">
            <h2>Audience</h2>
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Browsers</h3>
                <table>
                    <tbody>
                        {topBrowsers.map(([name, count]) => (
                            <tr>
                                <td>{name}</td>
                                <td class="stat-value" style="text-align: right;">{count}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Operating Systems</h3>
                <table>
                    <tbody>
                        {topOS.map(([name, count]) => (
                            <tr>
                                <td>{name}</td>
                                <td class="stat-value" style="text-align: right;">{count}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
             <div>
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Referrers</h3>
                <table>
                    <tbody>
                        {topReferrers.map(([name, count]) => (
                            <tr>
                                <td>{name}</td>
                                <td class="stat-value" style="text-align: right;">{count}</td>
                            </tr>
                        ))}
                         {topReferrers.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No referrer data</td></tr>}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Content Interaction (FAQ) -->
        <div class="card">
            <h2>Content Interest</h2>
            <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Top Questions (FAQ)</h3>
            <table>
                <tbody>
                    {topFAQs.map(([q, count]) => (
                        <tr>
                            <td class="text-xs">{q}</td>
                            <td class="stat-value" style="text-align: right;">{count}</td>
                        </tr>
                    ))}
                    {topFAQs.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No interaction yet</td></tr>}
                </tbody>
            </table>
        </div>

        <!-- Scroll Depth & Behavior -->
        <div class="card">
            <h2>Reading Habits</h2>
             <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Scroll Depth</h3>
                <table>
                    <tbody>
                        {scrollKeys.map(depth => (
                            <tr>
                                <td>{depth}%</td>
                                <td class="stat-value" style="text-align: right;">{scrollDepth[depth]}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            <div>
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Behavior</h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div style="flex: 1; text-align: center; padding: 1rem; background: #333; border-radius: 8px;">
                        <div style="color: #22c55e; font-size: 1.5rem; font-weight: bold;">{readingBehavior.read}</div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; color: #888;">Readers</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 1rem; background: #333; border-radius: 8px;">
                        <div style="color: #eab308; font-size: 1.5rem; font-weight: bold;">{readingBehavior.skim}</div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; color: #888;">Skimmers</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Funnel -->
        <div class="card">
            <h2>Calculator Funnel</h2>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.5rem;">
                 <!-- Start -->
                 <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 80px; font-size: 0.8rem; color: #aaa;">Started</div>
                    <div style="flex: 1; background: #333; height: 24px; border-radius: 4px; overflow: hidden; position: relative;">
                        <div style="width: 100%; background: #ef4444; height: 100%;"></div>
                        <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.75rem; color: white; font-weight: bold;">{calculator.start}</span>
                    </div>
                    <div style="width: 40px; text-align: right; font-size: 0.8rem; color: #ef4444;">100%</div>
                 </div>

                 <!-- Steps -->
                 {stepKeys.map(step => {
                     const count = calculator.steps[step];
                     const pct = calculator.start > 0 ? (count / calculator.start) * 100 : 0;
                     return (
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 80px; font-size: 0.8rem; color: #aaa;">Step {step}</div>
                            <div style="flex: 1; background: #333; height: 24px; border-radius: 4px; overflow: hidden; position: relative;">
                                <div style={`width: ${pct}%; background: #f97316; height: 100%; transition: width 0.5s;`}></div>
                                <span style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-size: 0.75rem; color: white; font-weight: bold; text-shadow: 0 1px 2px black;">{count}</span>
                            </div>
                            <div style="width: 40px; text-align: right; font-size: 0.8rem; color: #f97316;">{Math.round(pct)}%</div>
                        </div>
                     )
                 })}

                 <!-- Submitted -->
                 <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 80px; font-size: 0.8rem; color: #aaa;">Submitted</div>
                    <div style="flex: 1; background: #333; height: 24px; border-radius: 4px; overflow: hidden; position: relative;">
                        <div style={`width: ${calculator.start > 0 ? (calculator.submit / calculator.start) * 100 : 0}%; background: #22c55e; height: 100%; transition: width 0.5s;`}></div>
                        <span style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-size: 0.75rem; color: white; font-weight: bold; text-shadow: 0 1px 2px black;">{calculator.submit}</span>
                    </div>
                    <div style="width: 40px; text-align: right; font-size: 0.8rem; color: #22c55e;">{calculator.start > 0 ? Math.round((calculator.submit / calculator.start) * 100) : 0}%</div>
                 </div>
            </div>
            <div style="text-align: center; font-size: 0.75rem; color: #666;">
                Funnel Conversion Rate: <span style="color: #eee;">{calculator.start > 0 ? ((calculator.submit / calculator.start) * 100).toFixed(1) : 0}%</span>
            </div>
        </div>

        <!-- Service Interest -->
        <div class="card">
            <h2>Service Interest</h2>
            <table>
                 <thead>
                    <tr>
                        <th>Service</th>
                        <th style="text-align: right;">Clicks</th>
                        <th style="text-align: right;">% of Home</th>
                    </tr>
                </thead>
                <tbody>
                    {serviceInterest.map((item) => (
                        <tr>
                            <td>
                                {item.name}
                                <div class="bar-container">
                                    <div class="bar" style={`width: ${(item.count / (serviceInterest[0]?.count || 1)) * 100}%`}></div>
                                </div>
                            </td>
                            <td class="stat-value" style="text-align: right;">{item.count}</td>
                            <td class="stat-value" style="text-align: right; color: #aaa;">{item.rate}%</td>
                        </tr>
                    ))}
                    {serviceInterest.length === 0 && <tr><td colspan="3" style="color: #666; text-align: center;">No clicks recorded</td></tr>}
                </tbody>
            </table>
        </div>

        <!-- Gallery -->
        <div class="card">
            <h2>Gallery Filters</h2>
            <table>
                 <thead>
                    <tr>
                        <th>Category</th>
                        <th style="text-align: right;">Views</th>
                    </tr>
                </thead>
                <tbody>
                    {topGallery.map(([name, count]) => (
                        <tr>
                            <td>{name}</td>
                            <td class="stat-value" style="text-align: right;">{count}</td>
                        </tr>
                    ))}
                    {topGallery.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No gallery interaction</td></tr>}
                </tbody>
            </table>
        </div>

         <!-- Intent & Events -->
        <div class="card">
            <h2>User Intent</h2>
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Copied Text</h3>
                <table>
                    <tbody>
                        {topIntents.map(([text, count]) => (
                            <tr>
                                <td style="font-family: monospace; font-size: 0.8rem; color: #ccc;">"{text}"</td>
                                <td class="stat-value" style="text-align: right;">{count}</td>
                            </tr>
                        ))}
                        {topIntents.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No text copied yet</td></tr>}
                    </tbody>
                </table>
            </div>

            <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">All Events</h3>
            <table>
                 <thead>
                    <tr>
                        <th>Event</th>
                        <th style="text-align: right;">Count</th>
                    </tr>
                </thead>
                <tbody>
                    {allEvents.map(([name, count]) => (
                        <tr>
                            <td>{name}</td>
                            <td class="stat-value" style="text-align: right;">{count}</td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>

        <!-- 404 Errors -->
        <div class="card" style="grid-column: span 2;">
            <h2>Recent 404 Errors</h2>
            <table>
                 <thead>
                    <tr>
                        <th>Time</th>
                        <th>Path</th>
                        <th>Referrer</th>
                    </tr>
                </thead>
                <tbody>
                    {notFoundErrors.map((err) => (
                        <tr>
                            <td class="text-xs text-gray-400">{new Date(err.timestamp).toLocaleString('de-DE')}</td>
                            <td class="font-mono text-sm text-red-400">{err.url}</td>
                            <td class="text-xs text-gray-400 max-w-[200px] truncate" title={err.referrer}>{err.referrer}</td>
                        </tr>
                    ))}
                    {notFoundErrors.length === 0 && <tr><td colspan="3" style="color: #666; text-align: center;">No 404 errors recorded</td></tr>}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Danger Zone -->
    <div style="margin-top: 4rem; padding-top: 2rem; border-top: 1px solid #333; text-align: center;">
        <h3 style="color: #ef4444; margin-bottom: 1rem;">Danger Zone</h3>
        <button onclick="deleteAllData()" style="background: #ef4444; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
            ‚ö†Ô∏è DELETE ALL DATA
        </button>
        <p style="color: #666; font-size: 0.8rem; margin-top: 0.5rem;">This action cannot be undone.</p>
    </div>

    <div class="meta">
        Generated at {new Date().toLocaleString('de-DE')} | Protected Area
    </div>

    <script is:inline>
        async function deleteAllData() {
            if (!confirm('Are you absolutely sure? This will wipe all analytics data permanently.')) return;

            const url = new URL(window.location.href);
            const key = url.searchParams.get('key');

            try {
                const res = await fetch(`/api/delete-logs?key=${key}`, { method: 'POST' });
                if (res.ok) {
                    alert('Data deleted successfully.');
                    window.location.reload();
                } else {
                    alert('Failed to delete data.');
                }
            } catch (e) {
                alert('Error connecting to server.');
            }
        }

        // Simple reload for filtering to keep it robust without client-side heavy lifting
        function filterData(range) {
            const url = new URL(window.location.href);
            url.searchParams.set('range', range);
            window.location.href = url.toString();
        }

        // Set active button state based on URL
        const params = new URLSearchParams(window.location.search);
        const currentRange = params.get('range') || 'all';
        document.querySelectorAll('.btn').forEach(btn => {
            if (btn.textContent.toLowerCase().includes(currentRange === 'all' ? 'all' : (currentRange === '30d' ? '30' : '7'))) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    </script>
</body>
</html>
