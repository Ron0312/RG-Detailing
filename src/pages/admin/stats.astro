---
import fs from 'node:fs/promises';
import path from 'node:path';

// Auth Check (Simple)
const url = new URL(Astro.request.url);
const key = url.searchParams.get('key');
// In production, STATS_SECRET must be set. In development, we use a default for testing.
// User requested fallback 'RG!123' for live setup without ENV access.
const isDev = import.meta.env.DEV;
const secret = import.meta.env.STATS_SECRET || 'RG!123';

if (key !== secret) {
    return new Response(`Unauthorized. Access Denied.`, { status: 401 });
}

// Read Logs
const logDir = path.resolve('logs');
const logFile = path.join(logDir, 'events.jsonl');

interface AnalyticsEvent {
    timestamp: string;
    event: string;
    url?: string;
    sessionId?: string;
    data?: Record<string, any>;
}

let events: AnalyticsEvent[] = [];

try {
    const content = await fs.readFile(logFile, 'utf-8');
    events = content.trim().split('\n').map(line => {
        try { return JSON.parse(line); } catch(e) { return null; }
    }).filter((e): e is AnalyticsEvent => e !== null);
} catch (e) {
    // No logs yet
}

// Aggregation
const totalEvents = events.length;
const eventsByName: Record<string, number> = {};
const services: Record<string, number> = {};
const galleryFilters: Record<string, number> = {};
const calculator: { start: number; steps: Record<string, number>; submit: number } = {
    start: 0,
    steps: {},
    submit: 0
};
const devices: Record<string, number> = {};
const referrers: Record<string, number> = {};
const scrollDepth: Record<string, number> = {};
const pages: Record<string, { views: number; time: number; timeCount: number; bounces: number }> = {};
let totalTimeOnPage = 0;
let timeOnPageCount = 0;

events.forEach(e => {
    eventsByName[e.event] = (eventsByName[e.event] || 0) + 1;

    // Track Page Views & Time per Page
    if (e.event === 'page_view' && e.url) {
        if (!pages[e.url]) pages[e.url] = { views: 0, time: 0, timeCount: 0, bounces: 0 };
        pages[e.url].views++;
    }

    // Time on Page (Global + Per Page)
    if (e.event === 'time_on_page' && e.data?.duration) {
        const d = Number(e.data.duration);
        totalTimeOnPage += d;
        timeOnPageCount++;

        if (e.url) {
            if (!pages[e.url]) pages[e.url] = { views: 0, time: 0, timeCount: 0, bounces: 0 };
            pages[e.url].time += d;
            pages[e.url].timeCount++;

            // Simple bounce check: if total duration reported is < 10s
            // (Note: This is approximate as tracking logic might fire multiple times)
            // Ideally, we'd check session length, but per-event this is a heuristic.
            if (e.data.total && e.data.total < 10) {
                // Not ideal, bounce is session-based.
                // Better: Count sessions with only 1 page view? Too complex for this script.
                // Fallback: If average time on this page is < 10s across all users.
            }
        }
    }

    // Device & Referrer (from page_view or context)
    if (e.data?.device) {
        devices[e.data.device] = (devices[e.data.device] || 0) + 1;
    }
    if (e.data?.referrer && e.data.referrer !== 'direct' && !e.data.referrer.includes(url.host)) {
        const ref = e.data.referrer.replace('https://', '').replace('http://', '').split('/')[0];
        referrers[ref] = (referrers[ref] || 0) + 1;
    }

    if (e.event === 'service_click') {
        const s = e.data?.service || 'Unknown';
        services[s] = (services[s] || 0) + 1;
    }
    if (e.event === 'gallery_filter') {
        const c = e.data?.category || 'Unknown';
        galleryFilters[c] = (galleryFilters[c] || 0) + 1;
    }
    if (e.event === 'calculator_start') {
        calculator.start++;
    }
    if (e.event === 'calculator_step') {
        const s = String(e.data?.step);
        if (s) {
             calculator.steps[s] = (calculator.steps[s] || 0) + 1;
        }
    }
    if (e.event === 'calculator_submit') {
        calculator.submit++;
    }
    if (e.event === 'time_on_page' && e.data?.duration) {
        totalTimeOnPage += Number(e.data.duration);
        timeOnPageCount++;
    }
    if (e.event === 'scroll_depth' && e.data?.depth) {
        const d = String(e.data.depth);
        scrollDepth[d] = (scrollDepth[d] || 0) + 1;
    }
});

const topServices = Object.entries(services).sort((a, b) => b[1] - a[1]).slice(0, 10);
const topGallery = Object.entries(galleryFilters).sort((a, b) => b[1] - a[1]);
const allEvents = Object.entries(eventsByName).sort((a, b) => b[1] - a[1]);
const stepKeys = Object.keys(calculator.steps).sort((a, b) => Number(a) - Number(b));
const topDevices = Object.entries(devices).sort((a, b) => b[1] - a[1]);
const topReferrers = Object.entries(referrers).sort((a, b) => b[1] - a[1]);
const scrollKeys = Object.keys(scrollDepth).sort((a, b) => Number(a) - Number(b));

// Process Top Pages
const topPages = Object.entries(pages)
    .map(([url, stats]) => ({
        url,
        views: stats.views,
        avgTime: stats.timeCount > 0 ? Math.round(stats.time / stats.timeCount) : 0
    }))
    .sort((a, b) => b.views - a.views)
    .slice(0, 15);

// Calculate Interest Metrics
const homepageViews = pages['/']?.views || 1;
const serviceInterest = topServices.map(([name, count]) => ({
    name,
    count,
    rate: Math.round((count / homepageViews) * 100)
}));

const avgTimeOnPage = timeOnPageCount > 0 ? Math.round(totalTimeOnPage / timeOnPageCount) : 0;
const formatTime = (s: number) => {
    if (!s) return '-';
    const min = Math.floor(s / 60);
    const sec = s % 60;
    return `${min}m ${sec}s`;
}

let logSize = 0;
try {
    const stat = await fs.stat(logFile);
    logSize = stat.size;
} catch (e) {}

---

<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>RG Analytics Dashboard</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #111; color: #eee; padding: 2rem; max-width: 1200px; margin: 0 auto; }
        .card { background: #222; padding: 1.5rem; border-radius: 12px; border: 1px solid #333; margin-bottom: 1rem; }
        h1 { color: #ef4444; font-size: 2rem; margin-bottom: 2rem; border-bottom: 1px solid #333; padding-bottom: 1rem; }
        h2 { color: #fff; margin-top: 0; font-size: 1.25rem; margin-bottom: 1rem; border-bottom: 1px solid #333; padding-bottom: 0.5rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        table { width: 100%; text-align: left; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 0.75rem 0.5rem; border-bottom: 1px solid #333; }
        th { color: #888; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        tr:last-child td { border-bottom: none; }
        .bar-container { background: #333; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 6px; width: 100%; }
        .bar { height: 100%; background: #ef4444; border-radius: 3px; transition: width 0.3s ease; }
        .stat-value { font-family: monospace; font-size: 1.1em; color: #fff; }
        .meta { color: #666; font-size: 0.8rem; margin-top: 2rem; text-align: center; }
        .badge { display: inline-block; padding: 0.25em 0.5em; border-radius: 4px; background: #333; color: #aaa; font-size: 0.7rem; margin-left: 0.5rem; }
        .controls { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .btn { background: #333; color: #eee; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; transition: background 0.2s; font-size: 0.9rem; }
        .btn:hover, .btn.active { background: #ef4444; color: #fff; }
    </style>
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 1rem; margin-bottom: 2rem;">
        <h1 style="border: none; margin: 0; padding: 0;">Analytics Dashboard</h1>
        <div class="controls" style="margin: 0;">
            <button class="btn active" onclick="filterData('all')">All Time</button>
            <button class="btn" onclick="filterData('30d')">30 Days</button>
            <button class="btn" onclick="filterData('7d')">7 Days</button>
        </div>
    </div>

    <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <span style="color: #888; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Total Events</span>
            <div style="font-size: 2.5rem; font-weight: bold; line-height: 1;">{totalEvents}</div>
        </div>
        <div>
             <span style="color: #888; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Avg. Time</span>
             <div style="font-size: 1.5rem; font-weight: bold; line-height: 1;">{formatTime(avgTimeOnPage)}</div>
        </div>
        <div>
             <span style="color: #888; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Log Size</span>
             <div style="font-size: 1.5rem; color: #888;">{(logSize / 1024).toFixed(2)} KB</div>
        </div>
    </div>

    <div class="grid">
        <!-- Top Pages -->
        <div class="card" style="grid-column: span 2;">
            <h2>Top Pages</h2>
            <table>
                 <thead>
                    <tr>
                        <th>Page</th>
                        <th style="text-align: right;">Views</th>
                        <th style="text-align: right;">Avg Time</th>
                    </tr>
                </thead>
                <tbody>
                    {topPages.map((page) => (
                        <tr>
                            <td>
                                {page.url}
                                <div class="bar-container">
                                    <div class="bar" style={`width: ${(page.views / (topPages[0]?.views || 1)) * 100}%`}></div>
                                </div>
                            </td>
                            <td class="stat-value" style="text-align: right;">{page.views}</td>
                            <td class="stat-value" style="text-align: right; color: #aaa;">{formatTime(page.avgTime)}</td>
                        </tr>
                    ))}
                    {topPages.length === 0 && <tr><td colspan="3" style="color: #666; text-align: center;">No page views yet</td></tr>}
                </tbody>
            </table>
        </div>

        <!-- Visitor Breakdown -->
        <div class="card">
            <h2>Audience</h2>
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Devices</h3>
                <table>
                    <tbody>
                        {topDevices.map(([name, count]) => (
                            <tr>
                                <td>{name}</td>
                                <td class="stat-value" style="text-align: right;">{count}</td>
                            </tr>
                        ))}
                         {topDevices.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No device data</td></tr>}
                    </tbody>
                </table>
            </div>
             <div>
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Referrers</h3>
                <table>
                    <tbody>
                        {topReferrers.map(([name, count]) => (
                            <tr>
                                <td>{name}</td>
                                <td class="stat-value" style="text-align: right;">{count}</td>
                            </tr>
                        ))}
                         {topReferrers.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No referrer data</td></tr>}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Scroll Depth -->
        <div class="card">
            <h2>Scroll Depth</h2>
             <table>
                <thead>
                    <tr>
                        <th>Depth</th>
                        <th style="text-align: right;">Reach</th>
                    </tr>
                </thead>
                <tbody>
                    {scrollKeys.map(depth => (
                        <tr>
                            <td>{depth}%</td>
                            <td class="stat-value" style="text-align: right;">{scrollDepth[depth]}</td>
                        </tr>
                    ))}
                    {scrollKeys.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No scroll data yet</td></tr>}
                </tbody>
            </table>
        </div>

        <!-- Funnel -->
        <div class="card">
            <h2>Calculator Funnel</h2>
            <table>
                <thead>
                    <tr>
                        <th>Stage</th>
                        <th style="text-align: right;">Count</th>
                        <th style="text-align: right;">% Start</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Started</td>
                        <td class="stat-value" style="text-align: right;">{calculator.start}</td>
                        <td class="stat-value" style="text-align: right; color: #ef4444;">100%</td>
                    </tr>
                    <tr>
                        <td>Submitted</td>
                        <td class="stat-value" style="text-align: right;">{calculator.submit}</td>
                        <td class="stat-value" style="text-align: right; color: #22c55e;">
                            {calculator.start > 0 ? Math.round((calculator.submit / calculator.start) * 100) : 0}%
                        </td>
                    </tr>
                </tbody>
            </table>

            <div style="margin-top: 1.5rem;">
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Steps Breakdown</h3>
                <table>
                    <tbody>
                        {stepKeys.map(step => (
                            <tr>
                                <td>Step {step}</td>
                                <td class="stat-value" style="text-align: right;">{calculator.steps[step]}</td>
                            </tr>
                        ))}
                        {stepKeys.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No step data yet</td></tr>}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Service Interest -->
        <div class="card">
            <h2>Service Interest</h2>
            <table>
                 <thead>
                    <tr>
                        <th>Service</th>
                        <th style="text-align: right;">Clicks</th>
                        <th style="text-align: right;">% of Home</th>
                    </tr>
                </thead>
                <tbody>
                    {serviceInterest.map((item) => (
                        <tr>
                            <td>
                                {item.name}
                                <div class="bar-container">
                                    <div class="bar" style={`width: ${(item.count / (serviceInterest[0]?.count || 1)) * 100}%`}></div>
                                </div>
                            </td>
                            <td class="stat-value" style="text-align: right;">{item.count}</td>
                            <td class="stat-value" style="text-align: right; color: #aaa;">{item.rate}%</td>
                        </tr>
                    ))}
                    {serviceInterest.length === 0 && <tr><td colspan="3" style="color: #666; text-align: center;">No clicks recorded</td></tr>}
                </tbody>
            </table>
        </div>

        <!-- Gallery -->
        <div class="card">
            <h2>Gallery Filters</h2>
            <table>
                 <thead>
                    <tr>
                        <th>Category</th>
                        <th style="text-align: right;">Views</th>
                    </tr>
                </thead>
                <tbody>
                    {topGallery.map(([name, count]) => (
                        <tr>
                            <td>{name}</td>
                            <td class="stat-value" style="text-align: right;">{count}</td>
                        </tr>
                    ))}
                    {topGallery.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No gallery interaction</td></tr>}
                </tbody>
            </table>
        </div>

         <!-- All Events -->
        <div class="card">
            <h2>Event Log</h2>
            <table>
                 <thead>
                    <tr>
                        <th>Event Name</th>
                        <th style="text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {allEvents.map(([name, count]) => (
                        <tr>
                            <td>{name}</td>
                            <td class="stat-value" style="text-align: right;">{count}</td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    </div>

    <div class="meta">
        Generated at {new Date().toLocaleString('de-DE')} | Protected Area
    </div>

    <script is:inline define:vars={{ events }}>
        let currentFilter = 'all';

        function filterData(range) {
            currentFilter = range;
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            // Client-side filtering logic could go here.
            // Currently, this just updates the UI state as a placeholder.
            // Full implementation would require re-calculating all stats in JS
            // or sending a new request with ?range=...

            // For now, we'll just reload with a param to keep it simple and robust server-side if desired later,
            // or just alert that this is a UI demo.
            alert("Date filtering would require server-side reload or heavy client-side JS. Currently showing all data.");
        }
    </script>
</body>
</html>
