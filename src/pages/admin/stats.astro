---
import fs from 'node:fs/promises';
import path from 'node:path';

// Auth Check (Simple)
const url = new URL(Astro.request.url);
const key = url.searchParams.get('key');
const isDev = import.meta.env.DEV;
const secret = import.meta.env.STATS_SECRET || 'RG!123';

if (key !== secret) {
    return new Response(`Unauthorized. Access Denied.`, { status: 401 });
}

// Read Logs
const logDir = path.resolve('logs');
const logFile = path.join(logDir, 'events.jsonl');
const errorLogFile = path.join(logDir, '404.log');

interface AnalyticsEvent {
    timestamp: string;
    event: string;
    url?: string;
    sessionId?: string;
    visitorId?: string; // Persistent if consented
    dailyHash?: string; // Anonymous daily unique
    browser?: string;
    os?: string;
    data?: Record<string, any>;
}

let events: AnalyticsEvent[] = [];
let notFoundErrors: { timestamp: string; url: string; referrer: string; ua: string; }[] = [];

try {
    const content = await fs.readFile(logFile, 'utf-8');
    events = content.trim().split('\n').map(line => {
        try { return JSON.parse(line); } catch(e) { return null; }
    }).filter((e): e is AnalyticsEvent => e !== null);
} catch (e) {
    // No logs yet
}

try {
    const errorContent = await fs.readFile(errorLogFile, 'utf-8');
    // Parse: [ISO] 404: /url (Referrer: ...) - UA: ...
    notFoundErrors = errorContent.trim().split('\n').map(line => {
        const match = line.match(/^\[(.*?)\] 404: (.*?) \(Referrer: (.*?)\) - UA: (.*)$/);
        if (match) {
            return {
                timestamp: match[1],
                url: match[2],
                referrer: match[3],
                ua: match[4]
            };
        }
        return null;
    }).filter((e): e is NonNullable<typeof e> => e !== null).reverse().slice(0, 50); // Last 50 errors
} catch (e) {
    // No error logs yet
}

// Aggregation
const totalEvents = events.length;
const eventsByName: Record<string, number> = {};
const services: Record<string, number> = {};
const galleryFilters: Record<string, number> = {};
const calculator: { start: number; steps: Record<string, number>; submit: number } = {
    start: 0,
    steps: {},
    submit: 0
};
const devices: Record<string, number> = {};
const browsers: Record<string, number> = {};
const os: Record<string, number> = {};
const referrers: Record<string, number> = {};
const scrollDepth: Record<string, number> = {};
const pages: Record<string, { views: number; time: number; timeCount: number; bounces: number }> = {};
const readingBehavior: Record<string, number> = { read: 0, skim: 0 };
const intents: Record<string, number> = {};
let totalTimeOnPage = 0;
let timeOnPageCount = 0;

// Temporal Data for Charts
const history: Record<string, { views: number; visitors: Set<string> }> = {};

events.forEach(e => {
    // Date Key (YYYY-MM-DD)
    const dateKey = e.timestamp.split('T')[0];
    if (!history[dateKey]) history[dateKey] = { views: 0, visitors: new Set() };

    eventsByName[e.event] = (eventsByName[e.event] || 0) + 1;

    // Track Views & Visitors
    if (e.event === 'page_view') {
        history[dateKey].views++;
        // Use visitorId if available, else dailyHash, else sessionId
        const uniqueId = e.visitorId || e.dailyHash || e.sessionId;
        if (uniqueId) history[dateKey].visitors.add(uniqueId);

        if (e.url) {
            if (!pages[e.url]) pages[e.url] = { views: 0, time: 0, timeCount: 0, bounces: 0 };
            pages[e.url].views++;
        }
    }

    // Context Stats
    if (e.data?.device) devices[e.data.device] = (devices[e.data.device] || 0) + 1;
    if (e.browser) browsers[e.browser] = (browsers[e.browser] || 0) + 1;
    if (e.os) os[e.os] = (os[e.os] || 0) + 1;

    if (e.data?.referrer && e.data.referrer !== 'direct' && !e.data.referrer.includes(url.host)) {
        const ref = e.data.referrer.replace('https://', '').replace('http://', '').split('/')[0];
        referrers[ref] = (referrers[ref] || 0) + 1;
    }

    if (e.event === 'service_click') {
        const s = e.data?.service || 'Unknown';
        services[s] = (services[s] || 0) + 1;
    }
    if (e.event === 'gallery_filter') {
        const c = e.data?.category || 'Unknown';
        galleryFilters[c] = (galleryFilters[c] || 0) + 1;
    }
    if (e.event === 'calculator_start') {
        calculator.start++;
    }
    if (e.event === 'calculator_step') {
        const s = String(e.data?.step);
        if (s) {
             calculator.steps[s] = (calculator.steps[s] || 0) + 1;
        }
    }
    if (e.event === 'calculator_submit') {
        calculator.submit++;
    }
    if (e.event === 'time_on_page' && e.data?.duration) {
        const d = Number(e.data.duration);
        totalTimeOnPage += d;
        timeOnPageCount++;
        if (e.url) {
            if (!pages[e.url]) pages[e.url] = { views: 0, time: 0, timeCount: 0, bounces: 0 };
            pages[e.url].time += d;
            pages[e.url].timeCount++;
        }
    }
    if (e.event === 'scroll_depth' && e.data?.depth) {
        const d = String(e.data.depth);
        scrollDepth[d] = (scrollDepth[d] || 0) + 1;
    }
    if (e.event === 'reading_behavior' && e.data?.type) {
        const t = e.data.type as 'read' | 'skim';
        if (readingBehavior[t] !== undefined) readingBehavior[t]++;
    }
    if (e.event === 'intent_copy' && e.data?.text) {
        const t = String(e.data.text);
        intents[t] = (intents[t] || 0) + 1;
    }
});

// Calculate History Array (Last 30 Days)
const sortedDates = Object.keys(history).sort();
// Fill missing dates? For simple MVP, just show active days.
const chartData = sortedDates.map(date => ({
    date,
    views: history[date].views,
    visitors: history[date].visitors.size
}));

const totalUniqueVisitors = new Set(events.map(e => e.visitorId || e.dailyHash || e.sessionId).filter(Boolean)).size;

const topServices = Object.entries(services).sort((a, b) => b[1] - a[1]).slice(0, 10);
const topGallery = Object.entries(galleryFilters).sort((a, b) => b[1] - a[1]);
const allEvents = Object.entries(eventsByName).sort((a, b) => b[1] - a[1]);
const stepKeys = Object.keys(calculator.steps).sort((a, b) => Number(a) - Number(b));
const topDevices = Object.entries(devices).sort((a, b) => b[1] - a[1]);
const topBrowsers = Object.entries(browsers).sort((a, b) => b[1] - a[1]);
const topOS = Object.entries(os).sort((a, b) => b[1] - a[1]);
const topReferrers = Object.entries(referrers).sort((a, b) => b[1] - a[1]);
const scrollKeys = Object.keys(scrollDepth).sort((a, b) => Number(a) - Number(b));
const topIntents = Object.entries(intents).sort((a, b) => b[1] - a[1]).slice(0, 5);

// Process Top Pages
const topPages = Object.entries(pages)
    .map(([url, stats]) => ({
        url,
        views: stats.views,
        avgTime: stats.views > 0 ? Math.round(stats.time / stats.views) : 0 // Corrected average logic
    }))
    .sort((a, b) => b.views - a.views)
    .slice(0, 15);

// Calculate Interest Metrics
const homepageViews = pages['/']?.views || 1;
const serviceInterest = topServices.map(([name, count]) => ({
    name,
    count,
    rate: Math.round((count / homepageViews) * 100)
}));

const totalViews = events.filter(e => e.event === 'page_view').length;
const avgTimeOnPage = totalViews > 0 ? Math.round(totalTimeOnPage / totalViews) : 0;
const formatTime = (s: number) => {
    if (!s) return '-';
    const min = Math.floor(s / 60);
    const sec = s % 60;
    return `${min}m ${sec}s`;
}

let logSize = 0;
try {
    const stat = await fs.stat(logFile);
    logSize = stat.size;
} catch (e) {}

// SVG Chart Generator
const maxVal = Math.max(...chartData.map(d => d.views), 10);
const chartHeight = 150;
const chartWidth = 1000;
const pointsViews = chartData.map((d, i) => {
    const x = (i / (chartData.length - 1 || 1)) * chartWidth;
    const y = chartHeight - (d.views / maxVal) * chartHeight;
    return `${x},${y}`;
}).join(' ');
const pointsVisitors = chartData.map((d, i) => {
    const x = (i / (chartData.length - 1 || 1)) * chartWidth;
    const y = chartHeight - (d.visitors / maxVal) * chartHeight;
    return `${x},${y}`;
}).join(' ');

---

<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>RG Analytics Dashboard</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #111; color: #eee; padding: 2rem; max-width: 1200px; margin: 0 auto; }
        .card { background: #222; padding: 1.5rem; border-radius: 12px; border: 1px solid #333; margin-bottom: 1rem; }
        h1 { color: #ef4444; font-size: 2rem; margin-bottom: 2rem; border-bottom: 1px solid #333; padding-bottom: 1rem; }
        h2 { color: #fff; margin-top: 0; font-size: 1.25rem; margin-bottom: 1rem; border-bottom: 1px solid #333; padding-bottom: 0.5rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        table { width: 100%; text-align: left; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 0.75rem 0.5rem; border-bottom: 1px solid #333; }
        th { color: #888; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        tr:last-child td { border-bottom: none; }
        .bar-container { background: #333; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 6px; width: 100%; }
        .bar { height: 100%; background: #ef4444; border-radius: 3px; transition: width 0.3s ease; }
        .stat-value { font-family: monospace; font-size: 1.1em; color: #fff; }
        .meta { color: #666; font-size: 0.8rem; margin-top: 2rem; text-align: center; }
        .badge { display: inline-block; padding: 0.25em 0.5em; border-radius: 4px; background: #333; color: #aaa; font-size: 0.7rem; margin-left: 0.5rem; }
        .controls { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .btn { background: #333; color: #eee; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; transition: background 0.2s; font-size: 0.9rem; }
        .btn:hover, .btn.active { background: #ef4444; color: #fff; }

        /* Chart */
        .chart-container { width: 100%; height: 200px; position: relative; margin-bottom: 2rem; }
        svg { width: 100%; height: 100%; overflow: visible; }
        .line-views { fill: none; stroke: #ef4444; stroke-width: 2; }
        .line-visitors { fill: none; stroke: #3b82f6; stroke-width: 2; stroke-dasharray: 4; }
        .axis { stroke: #444; stroke-width: 1; }
        .tooltip { position: absolute; background: #333; padding: 0.5rem; border-radius: 4px; border: 1px solid #555; pointer-events: none; opacity: 0; transition: opacity 0.2s; }
        .legend { display: flex; gap: 1rem; font-size: 0.8rem; justify-content: flex-end; margin-bottom: 0.5rem; }
        .dot { width: 8px; height: 8px; display: inline-block; border-radius: 50%; }
    </style>
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 1rem; margin-bottom: 2rem;">
        <h1 style="border: none; margin: 0; padding: 0;">Analytics Dashboard</h1>
        <div class="controls" style="margin: 0;">
            <button class="btn active" onclick="filterData('all')">All Time</button>
            <button class="btn" onclick="filterData('30d')">30 Days</button>
            <button class="btn" onclick="filterData('7d')">7 Days</button>
        </div>
    </div>

    <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <span style="color: #888; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Views (Total)</span>
            <div style="font-size: 2.5rem; font-weight: bold; line-height: 1;">{totalEvents}</div>
        </div>
        <div>
            <span style="color: #888; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Unique Visitors</span>
            <div style="font-size: 2.5rem; font-weight: bold; line-height: 1; color: #3b82f6;">{totalUniqueVisitors}</div>
        </div>
        <div>
             <span style="color: #888; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Avg. Time</span>
             <div style="font-size: 1.5rem; font-weight: bold; line-height: 1;">{formatTime(avgTimeOnPage)}</div>
        </div>
    </div>

    <!-- Chart -->
    <div class="card">
        <h2>Trends (Last 30 Days)</h2>
        <div class="legend">
            <span style="color: #ef4444;"><span class="dot" style="background: #ef4444;"></span> Page Views</span>
            <span style="color: #3b82f6;"><span class="dot" style="background: #3b82f6;"></span> Unique Visitors</span>
        </div>
        <div class="chart-container">
            <svg viewBox={`0 0 ${chartWidth} ${chartHeight}`} preserveAspectRatio="none">
                <!-- Axes -->
                <line x1="0" y1={chartHeight} x2={chartWidth} y2={chartHeight} class="axis" />
                <line x1="0" y1="0" x2="0" y2={chartHeight} class="axis" />

                <!-- Data Lines -->
                <polyline points={pointsViews} class="line-views" />
                <polyline points={pointsVisitors} class="line-visitors" />
            </svg>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #888;">
            <span>{chartData[0]?.date}</span>
            <span>{chartData[chartData.length - 1]?.date}</span>
        </div>
    </div>

    <div class="grid">
        <!-- Top Pages -->
        <div class="card" style="grid-column: span 2;">
            <h2>Top Pages</h2>
            <table>
                 <thead>
                    <tr>
                        <th>Page</th>
                        <th style="text-align: right;">Views</th>
                        <th style="text-align: right;">Avg Time</th>
                    </tr>
                </thead>
                <tbody>
                    {topPages.map((page) => (
                        <tr>
                            <td>
                                {page.url}
                                <div class="bar-container">
                                    <div class="bar" style={`width: ${(page.views / (topPages[0]?.views || 1)) * 100}%`}></div>
                                </div>
                            </td>
                            <td class="stat-value" style="text-align: right;">{page.views}</td>
                            <td class="stat-value" style="text-align: right; color: #aaa;">{formatTime(page.avgTime)}</td>
                        </tr>
                    ))}
                    {topPages.length === 0 && <tr><td colspan="3" style="color: #666; text-align: center;">No page views yet</td></tr>}
                </tbody>
            </table>
        </div>

        <!-- Visitor Breakdown -->
        <div class="card">
            <h2>Audience</h2>
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Browsers</h3>
                <table>
                    <tbody>
                        {topBrowsers.map(([name, count]) => (
                            <tr>
                                <td>{name}</td>
                                <td class="stat-value" style="text-align: right;">{count}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Operating Systems</h3>
                <table>
                    <tbody>
                        {topOS.map(([name, count]) => (
                            <tr>
                                <td>{name}</td>
                                <td class="stat-value" style="text-align: right;">{count}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
             <div>
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Referrers</h3>
                <table>
                    <tbody>
                        {topReferrers.map(([name, count]) => (
                            <tr>
                                <td>{name}</td>
                                <td class="stat-value" style="text-align: right;">{count}</td>
                            </tr>
                        ))}
                         {topReferrers.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No referrer data</td></tr>}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Scroll Depth & Behavior -->
        <div class="card">
            <h2>Reading Habits</h2>
             <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Scroll Depth</h3>
                <table>
                    <tbody>
                        {scrollKeys.map(depth => (
                            <tr>
                                <td>{depth}%</td>
                                <td class="stat-value" style="text-align: right;">{scrollDepth[depth]}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            <div>
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Behavior</h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div style="flex: 1; text-align: center; padding: 1rem; background: #333; border-radius: 8px;">
                        <div style="color: #22c55e; font-size: 1.5rem; font-weight: bold;">{readingBehavior.read}</div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; color: #888;">Readers</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 1rem; background: #333; border-radius: 8px;">
                        <div style="color: #eab308; font-size: 1.5rem; font-weight: bold;">{readingBehavior.skim}</div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; color: #888;">Skimmers</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Funnel -->
        <div class="card">
            <h2>Calculator Funnel</h2>
            <table>
                <thead>
                    <tr>
                        <th>Stage</th>
                        <th style="text-align: right;">Count</th>
                        <th style="text-align: right;">% Start</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Started</td>
                        <td class="stat-value" style="text-align: right;">{calculator.start}</td>
                        <td class="stat-value" style="text-align: right; color: #ef4444;">100%</td>
                    </tr>
                    <tr>
                        <td>Submitted</td>
                        <td class="stat-value" style="text-align: right;">{calculator.submit}</td>
                        <td class="stat-value" style="text-align: right; color: #22c55e;">
                            {calculator.start > 0 ? Math.round((calculator.submit / calculator.start) * 100) : 0}%
                        </td>
                    </tr>
                </tbody>
            </table>

            <div style="margin-top: 1.5rem;">
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Steps Breakdown</h3>
                <table>
                    <tbody>
                        {stepKeys.map(step => (
                            <tr>
                                <td>Step {step}</td>
                                <td class="stat-value" style="text-align: right;">{calculator.steps[step]}</td>
                            </tr>
                        ))}
                        {stepKeys.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No step data yet</td></tr>}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Service Interest -->
        <div class="card">
            <h2>Service Interest</h2>
            <table>
                 <thead>
                    <tr>
                        <th>Service</th>
                        <th style="text-align: right;">Clicks</th>
                        <th style="text-align: right;">% of Home</th>
                    </tr>
                </thead>
                <tbody>
                    {serviceInterest.map((item) => (
                        <tr>
                            <td>
                                {item.name}
                                <div class="bar-container">
                                    <div class="bar" style={`width: ${(item.count / (serviceInterest[0]?.count || 1)) * 100}%`}></div>
                                </div>
                            </td>
                            <td class="stat-value" style="text-align: right;">{item.count}</td>
                            <td class="stat-value" style="text-align: right; color: #aaa;">{item.rate}%</td>
                        </tr>
                    ))}
                    {serviceInterest.length === 0 && <tr><td colspan="3" style="color: #666; text-align: center;">No clicks recorded</td></tr>}
                </tbody>
            </table>
        </div>

        <!-- Gallery -->
        <div class="card">
            <h2>Gallery Filters</h2>
            <table>
                 <thead>
                    <tr>
                        <th>Category</th>
                        <th style="text-align: right;">Views</th>
                    </tr>
                </thead>
                <tbody>
                    {topGallery.map(([name, count]) => (
                        <tr>
                            <td>{name}</td>
                            <td class="stat-value" style="text-align: right;">{count}</td>
                        </tr>
                    ))}
                    {topGallery.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No gallery interaction</td></tr>}
                </tbody>
            </table>
        </div>

         <!-- Intent & Events -->
        <div class="card">
            <h2>User Intent</h2>
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Copied Text</h3>
                <table>
                    <tbody>
                        {topIntents.map(([text, count]) => (
                            <tr>
                                <td style="font-family: monospace; font-size: 0.8rem; color: #ccc;">"{text}"</td>
                                <td class="stat-value" style="text-align: right;">{count}</td>
                            </tr>
                        ))}
                        {topIntents.length === 0 && <tr><td colspan="2" style="color: #666; text-align: center;">No text copied yet</td></tr>}
                    </tbody>
                </table>
            </div>

            <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">All Events</h3>
            <table>
                 <thead>
                    <tr>
                        <th>Event</th>
                        <th style="text-align: right;">Count</th>
                    </tr>
                </thead>
                <tbody>
                    {allEvents.map(([name, count]) => (
                        <tr>
                            <td>{name}</td>
                            <td class="stat-value" style="text-align: right;">{count}</td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>

        <!-- 404 Errors -->
        <div class="card" style="grid-column: span 2;">
            <h2>Recent 404 Errors</h2>
            <table>
                 <thead>
                    <tr>
                        <th>Time</th>
                        <th>Path</th>
                        <th>Referrer</th>
                    </tr>
                </thead>
                <tbody>
                    {notFoundErrors.map((err) => (
                        <tr>
                            <td class="text-xs text-gray-400">{new Date(err.timestamp).toLocaleString('de-DE')}</td>
                            <td class="font-mono text-sm text-red-400">{err.url}</td>
                            <td class="text-xs text-gray-400 max-w-[200px] truncate" title={err.referrer}>{err.referrer}</td>
                        </tr>
                    ))}
                    {notFoundErrors.length === 0 && <tr><td colspan="3" style="color: #666; text-align: center;">No 404 errors recorded</td></tr>}
                </tbody>
            </table>
        </div>
    </div>

    <div class="meta">
        Generated at {new Date().toLocaleString('de-DE')} | Protected Area
    </div>

    <script is:inline define:vars={{ events }}>
        let currentFilter = 'all';

        function filterData(range) {
            currentFilter = range;
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            // Client-side filtering logic could go here.
            // Currently, this just updates the UI state as a placeholder.
            // Full implementation would require re-calculating all stats in JS
            // or sending a new request with ?range=...

            // For now, we'll just reload with a param to keep it simple and robust server-side if desired later,
            // or just alert that this is a UI demo.
            alert("Date filtering would require server-side reload or heavy client-side JS. Currently showing all data.");
        }
    </script>
</body>
</html>
