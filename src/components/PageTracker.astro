<script>
  import { trackEvent } from '../lib/analytics';

  // Track Page Load
  window.addEventListener('load', () => {
    trackEvent('page_view', {
      device: window.innerWidth < 768 ? 'Mobile' : 'Desktop',
      platform: navigator.platform
    });
  });

  // Track Time on Page (Heartbeat + Visibility)
  let startTime = Date.now();
  let timeTracked = 0;

  const trackDuration = () => {
    const now = Date.now();
    const duration = Math.round((now - startTime) / 1000); // seconds
    if (duration > timeTracked && duration > 5) {
        trackEvent('time_on_page', { duration: duration - timeTracked, total: duration });
        timeTracked = duration;
    }
  };

  // Heartbeat every 30 seconds
  setInterval(trackDuration, 30000);

  // Visibility Change
  document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
          trackDuration();
      }
  });

  // Outbound Link Tracking
  document.addEventListener('click', (e) => {
      const link = (e.target as HTMLElement).closest('a');
      if (link && link.href) {
          const url = new URL(link.href);
          if (url.origin !== window.location.origin) {
              trackEvent('outbound_click', { url: link.href });
          }
      }
  });

  // Track Scroll Depth (25%, 50%, 75%, 100%)
  const thresholds = [25, 50, 75, 100];
  const tracked = new Set();

  const handleScroll = () => {
      const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
      const scrolled = window.scrollY;
      const percentage = Math.round((scrolled / scrollHeight) * 100);

      thresholds.forEach(t => {
          if (percentage >= t && !tracked.has(t)) {
              tracked.add(t);
              trackEvent('scroll_depth', { depth: t });
          }
      });
  };

  // Throttle scroll event
  let ticking = false;
  window.addEventListener('scroll', () => {
      if (!ticking) {
          window.requestAnimationFrame(() => {
              handleScroll();
              ticking = false;
          });
          ticking = true;
      }
  }, { passive: true });
</script>
