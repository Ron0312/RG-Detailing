<script>
  import { trackEvent } from '../lib/analytics';

  // Make trackEvent available globally for inline onclick handlers (e.g. Footer)
  window.trackEvent = trackEvent;

  // Track Page Load
  window.addEventListener('load', () => {
    // Simple Bot Check
    const isBot = /bot|googlebot|crawler|spider|robot|crawling/i.test(navigator.userAgent) || navigator.webdriver;
    if (isBot) return;

    trackEvent('page_view', {
      device: window.innerWidth < 768 ? 'Mobile' : 'Desktop',
      platform: navigator.platform
    });

    // LCP Tracking
    if ('PerformanceObserver' in window) {
        const observer = new PerformanceObserver((list) => {
            const entries = list.getEntries();
            const lastEntry = entries[entries.length - 1];
            trackEvent('performance_metric', { metric: 'LCP', value: Math.round(lastEntry.startTime) });
        });
        observer.observe({ type: 'largest-contentful-paint', buffered: true });
    }
  });

  // Track Time on Page (Heartbeat + Visibility)
  let startTime = Date.now();
  let timeTracked = 0;

  const trackDuration = () => {
    const now = Date.now();
    const duration = Math.round((now - startTime) / 1000); // seconds
    if (duration > timeTracked && duration > 5) {
        trackEvent('time_on_page', { duration: duration - timeTracked, total: duration });
        timeTracked = duration;
    }
  };

  // Heartbeat every 30 seconds
  setInterval(trackDuration, 30000);

  // Visibility Change
  document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
          trackDuration();
      }
  });

  // Outbound Link Tracking
  document.addEventListener('click', (e) => {
      const link = (e.target as HTMLElement).closest('a');
      if (link && link.href) {
          const url = new URL(link.href);
          if (url.origin !== window.location.origin) {
              trackEvent('outbound_click', { url: link.href });
          }
      }
  });

  // Intent Tracking: Copy
  document.addEventListener('copy', () => {
      const selection = document.getSelection();
      const text = selection ? selection.toString() : '';
      if (text.length > 5 && text.length < 100) { // Ignore huge copies or tiny accidental ones
          trackEvent('intent_copy', { text: text.substring(0, 50) });
      }
  });

  // Track Scroll Depth & Reading Behavior
  const thresholds = [25, 50, 75, 100];
  const tracked = new Set();
  let scrollStartTime = Date.now();

  const handleScroll = () => {
      const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
      const scrolled = window.scrollY;
      const percentage = Math.round((scrolled / scrollHeight) * 100);

      thresholds.forEach(t => {
          if (percentage >= t && !tracked.has(t)) {
              tracked.add(t);

              // Calculate reading speed to reach 50%
              if (t === 50) {
                  const timeToHalf = (Date.now() - scrollStartTime) / 1000;
                  const behavior = timeToHalf < 3 ? 'skim' : 'read'; // <3s to scroll 50% = skimming
                  trackEvent('reading_behavior', { type: behavior, seconds: Math.round(timeToHalf) });
              }

              trackEvent('scroll_depth', { depth: t });
          }
      });
  };

  // Throttle scroll event
  let ticking = false;
  window.addEventListener('scroll', () => {
      if (!ticking) {
          window.requestAnimationFrame(() => {
              handleScroll();
              ticking = false;
          });
          ticking = true;
      }
  }, { passive: true });
</script>
